# X-Slot 无线互联协议文档

## 目录
1. [需求概述](#1-需求概述)
2. [架构设计](#2-架构设计)
3. [协议规范](#3-协议规范)
4. [API参考](#4-api参考)
5. [快速开始](#5-快速开始)
6. [移植指南](#6-移植指南)
7. [故障排查](#7-故障排查)
8. [附录](#8-附录)

---

## 1. 需求概述

X-Slot 是专为 DDC（Direct Digital Controller）楼宇控制器设计的无线互联扩展协议，旨在解决 DDC 之间的无线组网、数据传输及设备管理问题。

### 1.1 业务场景

#### 1.1.1 数据连接场景
DDC 电路板预留 UART/SPI 接口，通过扩展模块实现不同功能。
- **DDC 无线互联（核心场景）**：
  DDC 插上 TP1107 无线模块，通过 Mesh 组网互联。汇聚 DDC（Hub）通过网口将所有数据传输至上层。协议 SDK 嵌入 DDC 中，将 BACnet 对象通过协议传输，汇聚节点接收数据并重新映射 Device ID。
- **DDC 与 IO 模块无线互联**：
  DDC 连接多个 IO 模块，IO 模块与 DDC 均插上无线模块，流程与 DDC 无线互联一致。
- **DDC 与 HMI 直连场景**：
  HMI 屏幕直连 DDC，用于显示数据。DDC 和 HMI 均运行协议栈，HMI 根据配置选择显示数据，走串口透传模式。

#### 1.1.2 配置场景
- **二次配置支持**：DDC 通过上层 PC 软件进行编程和配置（如三方通信口），协议栈 SDK 需支持配置接口。
- **配置工具连接**：配置工具通过网线或串口（Modbus/BACnet）连接 DDC，DDC 解析配置后操作子模块。
- **无线角色配置**：配置设备角色（汇聚节点/普通节点）。
- **HMI 模式配置**：配置 HMI 模式，使数据走串口直连而非 AT 指令模式。

### 1.2 系统目标
- **设备发现**：自动发现网络中的节点。
- **数据传输**：高效传输 BACnet 对象数据（支持 COV 增量上报）。
- **设备管理**：心跳监控、状态维护。
- **多模式支持**：支持 Mesh 无线模式和 HMI 串口直连模式。

---

## 2. 架构设计

### 2.1 系统概述
X-Slot 协议栈采用模块化设计，核心运行在 DDC 控制器上，支持 TP1107 470MHz Mesh 模块和 HMI 串口直连两种物理传输方式。

### 2.2 分层架构

```
┌─────────────────────────────────┐
│   1. 应用层 Application Layer   │
│   - BACnet Server               │
│   - 设备对象管理 / 配置管理     │
│   - COV通知                     │
├─────────────────────────────────┤
│   2. X-Slot协议层 Protocol Layer│
│   - XSlotManager (核心管理)     │
│   - MessageCodec (编解码)       │
│   - NodeTable (节点表)          │
│   - CommandHandler (指令处理)   │
├─────────────────────────────────┤
│   3. 传输抽象层 Transport Layer │
│   - ITransport (统一接口)       │
│   - ATTransport (TP1107 Mesh)   │
│   - DirectTransport (HMI直连)   │
├─────────────────────────────────┤
│   4. 硬件抽象层 HAL Layer       │
│   - SerialPort (串口驱动)       │
│   - Thread/Mutex (OS适配)       │
│   - Time functions              │
└─────────────────────────────────┘
```

### 2.3 核心组件

#### 2.3.1 XSlotManager
协议栈的大脑，负责：
- 节点全生命周期管理（上线、心跳、离线）。
- 数据收发调度与路由维护。
- 模式检测 (`xslot_detect_mode`) 与传输层切换。
- 用户回调分发。

#### 2.3.2 MessageCodec
消息编解码器，实现：
- 统一帧格式封装与解析。
- CRC16 校验。
- 调试日志输出。

#### 2.3.3 传输层实现 (Transport Strategy)

**A. 自动模式适配**
协议栈在 `xslot_start()` 启动时会自动探测硬件连接状态（通过发送探测指令），决定运行模式：
1.  **TPMesh 模式 (XSLOT_MODE_WIRELESS)**：检测到 TP1107 模组响应 (`AT` 返回 `OK`)。
    - 自动下发 `xslot_init` 传入的配置参数（地址、功率、信道等）到模组。
    - 启动 AT 指令交互状态机。
2.  **HMI 模式 (XSLOT_MODE_HMI)**：未检测到模组响应，但串口有 X-Slot 帧数据 (SYNC=0xAA)。
    - 切换为纯串口透传模式。
    - 直接解析数据帧。
3.  **空闲模式 (XSLOT_MODE_NONE)**：串口无任何有效响应。
    - 表示扩展槽未插入任何模块，或硬件连接异常。
    - 协议栈进入待机状态，不进行数据收发。

**B. 传输层实现**
1.  **TPMeshTransport (无线)**：
    - **TPMeshATDriver**：纯 AT 驱动，处理同步/异步 URC。
    - **逻辑层**：维护队列，默认使用 **Type 0 (UM)** 发送策略（应用层 SEQ 保障可靠性）。
2.  **DirectTransport (HMI)**：
    - 纯透传，自动剥离/添加 `SYNC` 帧头。
3.  **NullTransport (空闲)**：
    - 空实现，所有发送操作返回 `XSLOT_ERR_NO_DEVICE`。

#### 2.3.4 BACnet序列化器
支持双轨制序列化以优化带宽：
1.  **完整格式 (BACnetSerializer)**：[ID][TYPE][FLAGS][VALUE]，用于首次上报和读写。
2.  **增量格式 (BACnetIncrementalSerializer)**：[ID][HINT][VALUE]，省略类型和标志，用于高频 COV 上报（节省约 25% 流量）。

---

## 3. 协议规范

### 3.1 消息帧格式

```
┌──────┬────────┬────────┬──────┬──────┬──────┬────────────┬────────┐
│ SYNC │  FROM  │   TO   │ SEQ  │ CMD  │ LEN  │    DATA    │  CRC16 │
│ 1B   │  2B    │  2B    │  1B  │  1B  │  1B  │  0-128B    │  2B    │
└──────┴────────┴────────┴──────┴──────┴──────┴────────────┴────────┘
```
- **SYNC**: `0xAA`
- **SEQ**: 0-255 循环，用于去重和确认。
- **LEN**: 载荷长度。

### 3.2 命令类型

| 命令码 | 名称 | 方向 | 说明 |
|--------|------|------|------|
| 0x01 | PING | 双向 | 心跳请求 |
| 0x02 | PONG | 双向 | 心跳响应 |
| 0x10 | REPORT | 边缘→汇聚 | 数据上报 (BACnet COV) |
| 0x11 | QUERY | HMI→汇聚 | 数据查询 |
| 0x12 | RESPONSE | 汇聚→HMI | 查询响应 |
| 0x20 | WRITE | 汇聚→边缘 | 远程写入 |
| 0x21 | WRITE_ACK | 边缘→汇聚 | 写入确认 |

### 3.3 地址定义

| 地址范围 | 类型 | 说明 |
|----------|------|------|
| **0xFFFE** | 汇聚节点 | 网关固定地址 (Hub) |
| **0xFFBE - 0xFFFD** | 边缘节点 | 最多 64 个边缘节点 (DDC) |
| **0xFF00** | HMI | HMI 固定地址 |

### 3.4 通信流程

#### 3.4.1 启动与心跳
```
边缘节点         汇聚节点
   │                │
   ├─── PING ───────>│
   │<─── PONG ───────┤
   │                │
  (建议 30s-60s 重复，或无数据通信时发送)
```

#### 3.4.2 数据上报 (REPORT)
```
边缘节点         汇聚节点
   │                │
   ├─ REPORT(data) ─>│
   │                │ (更新节点表/BACnet对象)
```

#### 3.4.3 远程写入 (WRITE)
```
汇聚节点         边缘节点
   │                │
   ├─ WRITE(obj) ───>│
   │                │ (执行写入)
   │<─ WRITE_ACK ────┤
```

---

## 4. API参考

### 4.1 C API 核心接口

```c
// --- 初始化与控制 ---
// 初始化协议栈 (参数已包含地址、功率等配置)
xslot_handle_t xslot_init(const xslot_config_t* config);
void xslot_deinit(xslot_handle_t handle);

// 启动协议栈 (自动检测模式并应用配置)
int xslot_start(xslot_handle_t handle);
void xslot_stop(xslot_handle_t handle);

// --- 状态查询 ---
typedef enum {
    XSLOT_MODE_NONE = 0,      // 未检测到设备 (空闲/异常)
    XSLOT_MODE_WIRELESS = 1,  // TP1107 Mesh 模式
    XSLOT_MODE_HMI = 2        // HMI 串口直连模式
} xslot_run_mode_t;

// 获取当前运行模式 (在 start 成功后调用)
xslot_run_mode_t xslot_get_run_mode(xslot_handle_t handle);

// --- 运行时配置 (可选) ---
// 仅在需要运行时动态修改无线参数时调用
int xslot_update_wireless_config(xslot_handle_t handle, 
                                 uint8_t cell_id, int8_t power_dbm);

// --- 业务数据 ---
// 上报 BACnet 对象
int xslot_report_objects(xslot_handle_t handle, 
                         const xslot_bacnet_object_t* objects,
                         uint8_t count);
// 远程写入对象
int xslot_write_object(xslot_handle_t handle, uint16_t target,
                       const xslot_bacnet_object_t* obj);

// --- 回调注册 ---
void xslot_set_data_callback(xslot_handle_t handle, xslot_data_received_cb cb);
void xslot_set_node_callback(xslot_handle_t handle, xslot_node_online_cb cb);
```

### 4.2 AT 命令 (TPMesh 模式)
仅用于 `XSLOT_MODE_WIRELESS` 模式下底层交互。
- `AT+SEND=<ADDR>,<LEN>,<DATA>,<TYPE>`: 发送数据 (Type 0 UM)
- `+NNMI:<SRC>,<DEST>,<RSSI>,<LEN>,<DATA>`: 接收数据
- `+SEND:<SN>,<RESULT>`: 发送结果通知

---

## 5. 快速开始

### 5.1 编译构建 (Windows/Linux)
```bash
mkdir build && cd build
cmake ..
cmake --build . --config Release
```

### 5.2 示例：边缘节点上报
```c
xslot_config_t config = {0};
config.local_addr = 0xFFBE; // 边缘节点起始地址
config.heartbeat_interval_ms = 30000; // 30s 心跳

xslot_handle_t handle = xslot_init(&config);
int ret = xslot_start(handle);

// 检查启动结果和运行模式
xslot_run_mode_t mode = xslot_get_run_mode(handle);
if (mode == XSLOT_MODE_NONE) {
    printf("错误: 未检测到无线模组，请检查硬件连接\n");
    xslot_deinit(handle);
    return -1;
}
printf("运行模式: %s\n", mode == XSLOT_MODE_WIRELESS ? "Wireless" : "HMI");

while (1) {
    xslot_bacnet_object_t obj = {0};
    obj.object_id = 0;
    obj.value.analog_value = 25.5;
    xslot_report_objects(handle, &obj, 1);
    sleep(10);
}
```

### 5.3 示例：中心汇聚节点
```c
// 数据接收回调
void on_data_received(uint16_t from, const uint8_t* data, uint8_t len) {
    printf("收到来自 0x%04X 的数据，长度: %d\n", from, len);
    // 在此处反序列化 BACnet 对象并处理
}

// 节点上线回调
void on_node_online(uint16_t addr, bool online) {
    printf("节点 0x%04X %s\n", addr, online ? "上线" : "离线");
}

int main() {
    xslot_config_t config = {0};
    config.local_addr = 0xFFFE; // 汇聚节点固定地址
    config.cell_id = 1;
    config.power_dbm = 20;
    
    xslot_handle_t handle = xslot_init(&config);
    
    // 注册回调
    xslot_set_data_callback(handle, on_data_received);
    xslot_set_node_callback(handle, on_node_online);
    
    // 启动 (自动处理模组配置)
    int ret = xslot_start(handle);
    
    // 检查运行模式
    xslot_run_mode_t mode = xslot_get_run_mode(handle);
    if (mode == XSLOT_MODE_NONE) {
        printf("错误: 未检测到无线模组\n");
        xslot_deinit(handle);
        return -1;
    }
    printf("汇聚节点启动成功，模式: Wireless\n");
    
    // 主循环：中心节点主要处于监听状态，或主动下发控制
    while (1) {
        sleep(1);
    }
    
    xslot_stop(handle);
    xslot_deinit(handle);
    return 0;
}
```

### 5.4 示例：HMI 直连模式
```c
// HMI 端查询数据的回调
void on_response_received(uint16_t from, const uint8_t* data, uint8_t len) {
    // 反序列化 BACnet 对象并更新显示
    xslot_bacnet_object_t objects[16];
    int count = xslot_deserialize_objects(data, len, objects, 16);
    for (int i = 0; i < count; i++) {
        hmi_update_display(objects[i].object_id, objects[i].value.analog_value);
    }
}

int main() {
    xslot_config_t config = {0};
    config.local_addr = 0xFF00;  // HMI 固定地址
    config.uart_baudrate = 115200;
    
    xslot_handle_t handle = xslot_init(&config);
    xslot_set_data_callback(handle, on_response_received);
    
    // 启动 (自动检测为 HMI 直连模式)
    xslot_start(handle);
    
    // 确认运行模式
    xslot_run_mode_t mode = xslot_get_run_mode(handle);
    if (mode == XSLOT_MODE_NONE) {
        printf("错误: 未检测到 DDC 连接，请检查串口\n");
        xslot_deinit(handle);
        return -1;
    } else if (mode == XSLOT_MODE_HMI) {
        printf("HMI 直连模式已启动\n");
    } else {
        printf("警告: 检测到无线模组，非预期的 HMI 模式\n");
    }
    
    // 主循环：定时查询 DDC 数据
    while (1) {
        // 查询汇聚节点的指定对象
        uint16_t query_ids[] = {0, 1, 2};  // 查询 AI0, AI1, AI2
        xslot_query_objects(handle, 0xFFFE, query_ids, 3);
        
        sleep(5);  // 每 5 秒刷新一次
    }
    
    xslot_stop(handle);
    xslot_deinit(handle);
    return 0;
}
```

---

## 6. 移植指南

### 6.1 HAL 层适配
需实现 `src/hal/` 下的接口：
- `SerialPort`: 串口读写 (UART)。
- `Thread/Mutex`: FreeRTOS/RT-Thread 任务与锁。
- `Time`: 系统滴答时间。

### 6.2 嵌入式优化
- **内存**：`XSLOT_MAX_DATA_LEN` 降至 64 字节；限制 `XSLOT_MAX_NODES` 数量。
- **栈空间**：建议任务栈大小 4KB+。
- **HMI模式**：若仅用作 HMI 直连，可裁剪掉 AT 解析代码。

---

## 7. 故障排查

- **模块无响应 (XSLOT_MODE_NONE)**：
  - 检查波特率 (默认 115200) 及 VCC/GND/RX/TX 连接。
  - 确认扩展槽是否正确插入模块。
  - 使用串口工具手动发送 `AT\r\n` 测试模组响应。
- **路由建立失败**：确认地址是否在 `0xFFBE-0xFFFE` 范围内，Cell ID 是否一致。
- **数据丢包**：检查 RSSI，若信号弱 (-100dBm 以下)，尝试调高 `AT+PWR` 或增加中继节点。
- **模式检测错误**：
  - 若期望 Wireless 但返回 HMI：检查 TP1107 模组是否正常上电。
  - 若期望 HMI 但返回 NONE：确认 DDC 端协议栈已启动并有数据发送。

---

## 8. 附录

### A. 错误码表
| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| -1 | 参数错误 |
| -2 | 超时 |
| -3 | CRC 校验失败 |
| -6 | 节点离线 |
| -7 | 未检测到设备 (XSLOT_ERR_NO_DEVICE) |

### B. 版本历史
- **v1.0.0** (2025-01-15): 初始版本，支持 TP1107 Mesh 及 BACnet 序列化。
